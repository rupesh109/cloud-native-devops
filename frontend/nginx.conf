# Extract backend host from BACKEND_URL (http context is fine in conf.d)
map $BACKEND_URL $backend_host {
    "~^https?://([^/]+)" $1;
}

server {
  # Cloud Run exposes PORT; listen on it (falls back to 8080 locally if missing)
  listen       ${PORT};
  server_name  _;

  root  /usr/share/nginx/html;
  index index.html;

  # SPA routing
  location / {
    try_files $uri /index.html;
  }

  # ---- API proxy to Cloud Run backend ----
  # Use BACKEND_URL provided at deploy time (e.g. https://backend-xxx.run.app)
  set $backend "${BACKEND_URL}";
  resolver 8.8.8.8 1.1.1.1 ipv6=off;
  proxy_ssl_server_name on;

  location /api/ {
    # forward original client info
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # IMPORTANT: Cloud Run routes by Host header â†’ use backend host
    proxy_set_header Host $backend_host;

    # Strip /api prefix by using a trailing slash
    proxy_pass $backend/;

    proxy_http_version 1.1;
  }
}
